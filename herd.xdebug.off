#!/bin/bash

# --- Xdebug Disable Script for Laravel Herd ---
# This script disables Xdebug for better performance when not debugging
#
# Date: January 2025

echo "ğŸ›âŒ --- Disabling Xdebug for Laravel Herd --- âŒğŸ›"
echo "This script will disable Xdebug for better performance."
echo "----------------------------------------------------"

# --- Function to check if a command exists ---
command_exists () {
  type "$1" &> /dev/null ;
}

# --- 1. Check for Herd ---
echo "ğŸ” Checking for Herd..."
if ! command_exists herd ; then
  echo "âŒ Error: Herd is not found. Please install Herd (https://herd.laravel.com/) and ensure it's in your system's PATH."
  exit 1
fi
echo "âœ… Herd found."

# --- 2. Disable Xdebug ---
echo "ğŸ”§ Disabling Xdebug..."

# Define Herd PHP config directory
HERD_PHP_CONFIG_DIR="$HOME/Library/Application Support/Herd/config/php"

if [ ! -d "$HERD_PHP_CONFIG_DIR" ]; then
    echo "âŒ Error: Herd PHP config directory not found at $HERD_PHP_CONFIG_DIR"
    exit 1
fi

echo "ğŸ“ Found Herd PHP config directory: $HERD_PHP_CONFIG_DIR"

# Configure xdebug.mode in all PHP versions
echo "âš™ï¸ Configuring Xdebug mode to off in all PHP versions..."

for php_version_dir in "$HERD_PHP_CONFIG_DIR"/*; do
    if [ -d "$php_version_dir" ]; then
        PHP_VERSION=$(basename "$php_version_dir")
        PHP_INI_FILE="$php_version_dir/php.ini"
        
        if [ -f "$PHP_INI_FILE" ]; then
            echo "ğŸ”§ Checking PHP $PHP_VERSION: $PHP_INI_FILE"
            
            # Check if Xdebug is configured in this PHP version
            if grep -q "xdebug" "$PHP_INI_FILE"; then
                # Check if xdebug.mode exists and update/add it
                if grep -q "^xdebug.mode" "$PHP_INI_FILE"; then
                    # Update existing xdebug.mode
                    sed -i '' 's/^xdebug.mode.*/xdebug.mode=off/' "$PHP_INI_FILE"
                    echo "âœ… Updated xdebug.mode=off in PHP $PHP_VERSION"
                else
                    # Add xdebug.mode if it doesn't exist
                    echo "xdebug.mode=off" >> "$PHP_INI_FILE"
                    echo "âœ… Added xdebug.mode=off to PHP $PHP_VERSION"
                fi
            else
                echo "â­ï¸ Skipping PHP $PHP_VERSION - Xdebug not configured in php.ini"
            fi
        else
            echo "âš ï¸ Warning: php.ini not found for PHP $PHP_VERSION"
        fi
    fi
done

echo "âœ… Xdebug disabled successfully!"

# Restart Herd to apply changes
echo "ğŸ”„ Restarting Herd to apply configuration changes..."
herd restart
if [ $? -eq 0 ]; then
    echo "âœ… Herd restarted successfully!"
else
    echo "âš ï¸ Warning: Failed to restart Herd. You may need to restart manually."
fi

echo "ğŸš€ Performance improved - Xdebug overhead removed!"
